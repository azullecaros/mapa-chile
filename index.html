<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Mapa Regiones Chile</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; background:#F1F1F1; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .mapboxgl-popup-content { background: white; border-radius: 12px; padding: 16px; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
<script>
mapboxgl.accessToken = "pk.eyJ1IjoidmhpcnNjaGJlcmciLCJhIjoiY21lYmh4NDB4MG85bDJrcHdib21veGNubiJ9.WyoHoI8fXYX3VkEb42vKXg";

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-70.67, -33.45],
  zoom: 4
});

// Ajustar colores base
map.on('styledata', () => {
  if (map.getLayer('background')) {
    map.setPaintProperty('background', 'background-color', '#F1F1F1');
  }
  ['land', 'landcover', 'landuse'].forEach(id => {
    if (map.getLayer(id)) {
      try { map.setPaintProperty(id, 'fill-color', '#C3C3C3'); } catch(e){}
    }
  });
  if (map.getLayer('water')) {
    try { map.setPaintProperty('water', 'fill-color', '#F1F1F1'); } catch(e){}
  }
});

map.on('load', () => {
  // Fuente del tileset
  map.addSource('regiones-centros', {
    type: 'vector',
    url: 'mapbox://vhirschberg.69tq4hif'
  });

  // Círculos
  map.addLayer({
    id: 'centros-circulos',
    type: 'circle',
    source: 'regiones-centros',
    'source-layer': 'regiones_chile_centros-3ktyh3',
    paint: {
      'circle-radius': 20,
      'circle-color': '#E2D2F6',
      'circle-stroke-width': 2,
      'circle-stroke-color': '#fff'
    }
  });

  // Texto con total
  map.addLayer({
    id: 'centros-texto',
    type: 'symbol',
    source: 'regiones-centros',
    'source-layer': 'regiones_chile_centros-3ktyh3',
    layout: {
      'text-field': [
        'to-string',
        ['+', ['get','manuales'], ['+', ['get','maleta'], ['get','laboratorio móvil']]]
      ],
      'text-size': 14,
      'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold']
    },
    paint: { 'text-color': '#201245' }
  });

  // Popup al hacer click
  map.on('click', 'centros-circulos', (e) => {
    const f = e.features[0].properties;
    const nombre = f['región'];
    const man = f.manuales || 0;
    const mal = f.maleta || 0;
    const mob = f['laboratorio móvil'] || 0;

    const html = `
      <div style="font:700 18px system-ui; color:#201245; margin-bottom:12px;">${nombre}</div>
      <div style="display:flex; gap:12px; font: 14px system-ui;">
        <div style="flex:1; background:#E9E0F8; padding:12px; border-radius:12px; text-align:center;">
          <div style="font:700 20px system-ui; color:#201245;">${man}</div>
          <div>usuarios de <strong>Manuales</strong></div>
        </div>
        <div style="flex:1; background:#C9D9F1; padding:12px; border-radius:12px; text-align:center;">
          <div style="font:700 20px system-ui; color:#201245;">${mal}</div>
          <div>usuarios de <strong>Maleta</strong></div>
        </div>
        <div style="flex:1; background:#BFE8E8; padding:12px; border-radius:12px; text-align:center;">
          <div style="font:700 20px system-ui; color:#201245;">${mob}</div>
          <div>usuarios de <strong>MobileLab</strong></div>
        </div>
      </div>
    `;
    new mapboxgl.Popup({ offset: 14 }).setLngLat(e.lngLat).setHTML(html).addTo(map);
  });

  map.on('mouseenter', 'centros-circulos', () => {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('mouseleave', 'centros-circulos', () => {
    map.getCanvas().style.cursor = '';
  });
});
</script>
</body>
</html>


