<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Mapa de Chile - Regiones y Casos</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" rel="stylesheet" />
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  .mapboxgl-popup { max-width: 300px; font: 14px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif; }
  .boton-chile {
    position: absolute;
    top: 10px; left: 10px;
    z-index: 1;
    background: white;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
</style>
</head>
<body>

<div id="map"></div>
<div class="boton-chile" id="btnChile">Enfocar Chile</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
mapboxgl.accessToken = "pk.eyJ1IjoidmhpcnNjaGJlcmciLCJhIjoiY21lYmh4NDB4MG85bDJrcHdib21veGNubiJ9.WyoHoI8fXYX3VkEb42vKXg";

// Datos ficticios
const datosRegiones = [
  { region: "Arica y Parinacota", manuales: 120, maleta: 45, mobilelab: 30 },
  { region: "Tarapacá", manuales: 200, maleta: 60, mobilelab: 50 },
  { region: "Antofagasta", manuales: 300, maleta: 80, mobilelab: 70 },
  { region: "Atacama", manuales: 150, maleta: 50, mobilelab: 40 },
  { region: "Coquimbo", manuales: 400, maleta: 120, mobilelab: 100 },
  { region: "Valparaíso", manuales: 600, maleta: 200, mobilelab: 150 },
  { region: "Metropolitana de Santiago", manuales: 1200, maleta: 500, mobilelab: 400 },
  { region: "Libertador General Bernardo O'Higgins", manuales: 500, maleta: 160, mobilelab: 140 },
  { region: "Maule", manuales: 350, maleta: 110, mobilelab: 90 },
  { region: "Ñuble", manuales: 220, maleta: 80, mobilelab: 60 },
  { region: "Biobío", manuales: 550, maleta: 180, mobilelab: 150 },
  { region: "La Araucanía", manuales: 300, maleta: 100, mobilelab: 90 },
  { region: "Los Ríos", manuales: 200, maleta: 70, mobilelab: 60 },
  { region: "Los Lagos", manuales: 400, maleta: 150, mobilelab: 120 },
  { region: "Aysén del General Carlos Ibáñez del Campo", manuales: 80, maleta: 30, mobilelab: 25 },
  { region: "Magallanes y de la Antártica Chilena", manuales: 50, maleta: 20, mobilelab: 15 }
];

// Crear el mapa
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/standard',
  center: [-70.67, -33.45],
  zoom: 4
});

// Controles
map.addControl(new mapboxgl.NavigationControl(), 'top-right');
map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
map.addControl(new mapboxgl.ScaleControl(), 'bottom-left');
map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: { enableHighAccuracy: true },
  trackUserLocation: true
}), 'top-right');

const geocoder = new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl,
  countries: 'cl',
  language: 'es',
  placeholder: 'Buscar en Chile'
});
map.addControl(geocoder, 'top-left');

// Botón enfocar Chile
document.getElementById('btnChile').addEventListener('click', () => {
  geocoder.query('Chile');
});

// Esperar a que cargue el mapa
map.on('load', () => {
  // Añadir el tileset de regiones
  map.addSource('regiones', {
    type: 'vector',
    url: 'mapbox://vhirschberg.cst71ag7'
  });

  // Generar expresión para color
  const expression = ['match', ['get', 'región']];
  datosRegiones.forEach(d => {
    const total = d.manuales + d.maleta + d.mobilelab;
    let color;
    if (total > 800) color = '#800026';
    else if (total > 500) color = '#BD0026';
    else if (total > 300) color = '#E31A1C';
    else if (total > 200) color = '#FC4E2A';
    else if (total > 100) color = '#FD8D3C';
    else color = '#FEB24C';
    expression.push(d.region, color);
  });
  expression.push('#FFEDA0'); // color por defecto

  // Capa de relleno
  map.addLayer({
    id: 'regiones-fill',
    type: 'fill',
    source: 'regiones',
    'source-layer': 'regiones_chile_simple-4ltyfv',
    paint: {
      'fill-color': expression,
      'fill-opacity': 0.6
    }
  });

  // Borde
  map.addLayer({
    id: 'regiones-outline',
    type: 'line',
    source: 'regiones',
    'source-layer': 'regiones_chile_simple-4ltyfv',
    paint: {
      'line-color': '#555',
      'line-width': 1
    }
  });

  // Popup al hacer click
  map.on('click', 'regiones-fill', (e) => {
    const nombre = e.features[0].properties['región'];
    const datos = datosRegiones.find(r => r.region === nombre);
    if (datos) {
      const total = datos.manuales + datos.maleta + datos.mobilelab;
      const centro = turf.centerOfMass(e.features[0]).geometry.coordinates;
      new mapboxgl.Popup()
        .setLngLat(centro)
        .setHTML(`
          <strong>${nombre}</strong><br>
          Manuales: ${datos.manuales}<br>
          Maleta: ${datos.maleta}<br>
          Mobile Lab: ${datos.mobilelab}<br>
          <em>Total: ${total}</em><br>
          Coordenadas: ${centro[1].toFixed(4)}, ${centro[0].toFixed(4)}
        `)
        .addTo(map);
    }
  });

  // Cambiar cursor
  map.on('mouseenter', 'regiones-fill', () => {
    map.getCanvas().style.cursor = 'pointer';
  });
  map.on('mouseleave', 'regiones-fill', () => {
    map.getCanvas().style.cursor = '';
  });
});
</script>
</body>
</html>


